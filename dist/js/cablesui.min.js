function mouseEvent(e){return e.offsetX||(e.offsetX=e.layerX),e.offsetY||(e.offsetY=e.layerY),e}function valueChanger(e){function t(e){}function i(e){s=!0,document.addEventListener("pointerlockchange",r,!1),document.addEventListener("mozpointerlockchange",r,!1),document.addEventListener("webkitpointerlockchange",r,!1),document.addEventListener("keydown",t,!1),l.requestPointerLock=l.requestPointerLock||l.mozRequestPointerLock||l.webkitRequestPointerLock,l.requestPointerLock()}function n(e){s=!1,document.removeEventListener("pointerlockchange",r,!1),document.removeEventListener("mozpointerlockchange",r,!1),document.removeEventListener("webkitpointerlockchange",r,!1),document.removeEventListener("keydown",t,!1),document.exitPointerLock(),$(document).unbind("mouseup",n),$(document).unbind("mousedown",i),document.removeEventListener("mousemove",o,!1)}function o(t){var i=parseFloat($("#"+e).val(),10),n=t.movementY*-.5;(t.shiftKey||3==t.which)&&(n*=.005),i+=n,$("#"+e).val(i),$("#"+e).trigger("input")}function r(t){document.pointerLockElement===l||document.mozPointerLockElement===l||document.webkitPointerLockElement===l?document.addEventListener("mousemove",o,!1):($("#"+e).val(a),$("#"+e).trigger("input"),n())}var s=!1,a=$("#"+e).val(),l=document.getElementById(e);$(document).bind("mouseup",n),$(document).bind("mousedown",i)}function getPortOpacity(e){return e?e.direction==PORT_DIR_IN&&(e.isAnimated()||e.isLinked())?1:.6:void 0}function getPortDescription(e){var t="<b>"+e.getName()+"</b>";return t+=" ["+e.getTypeString()+"]",e.isLinked()&&(t+=" press right mouse button to unlink port"),t}function Line(e,t){var i={x:e,y:t};this.updateEnd=function(e,t){n.x=e,n.y=t,this.redraw()};var n={x:e,y:t};this.getPath=function(){var e=i.x,t=i.y,o=n.x,r=n.y;return"M "+e+" "+t+" L"+o+" "+r},this.thisLine=gui.patch().getPaper().path(this.getPath()),this.thisLine.attr({stroke:CABLES.UI.uiConfig.colorLink,"stroke-width":2}),this.redraw=function(){this.thisLine.attr("path",this.getPath())}}function UiLink(e,t){var i=this,n=30,o=30,r=null;this.linkLine=null,this.p1=e,this.p2=t,this.hideAddButton=function(){r&&r.remove(),r=null,this.linkLine&&this.linkLine.attr({"stroke-opacity":1,"stroke-width":1})},this.showAddButton=function(){this.isVisible()&&(this.linkLine.attr({"stroke-opacity":1,"stroke-width":2}),null===r?(r=gui.patch().getPaper().circle(n,o,.5*CABLES.UI.uiConfig.portSize).attr({stroke:CABLES.UI.uiConfig.getPortColor(i.p1.thePort),"stroke-width":2,fill:CABLES.UI.uiConfig.colorBackground}),r.hover(function(e){var t="left click: insert op / right click: delete link";CABLES.UI.showToolTip(e,t),CABLES.UI.setStatusText(t)},function(){CABLES.UI.hideToolTip()}),r.toFront(),r.node.onmousedown=function(e){$("#library").hide(),$("#patch").focus(),null!==i.p1&&(3==e.which?i.p1.thePort.removeLinkTo(i.p2.thePort):(e=mouseEvent(e),CABLES.UI.OPSELECT.showOpSelect(gui.patch().getCanvasCoordsMouse(e),null,null,i)))}):(r.attr({cx:n,cy:o}),r.toFront()))},this.getPath=function(){if(!t.rect)return"";if(!e.rect)return"";if(!t.rect.attrs)return"";if(!e.rect.attrs)return"";var i=e.rect.matrix.e+e.rect.attrs.x+CABLES.UI.uiConfig.portSize/2,r=e.rect.matrix.f+e.rect.attrs.y,s=t.rect.matrix.e+t.rect.attrs.x+CABLES.UI.uiConfig.portSize/2,a=t.rect.matrix.f+t.rect.attrs.y;n=.5*(i+s),o=.5*(r+a);var l=0,c=0,u=0,h=0;c=Math.min(r,a)+(Math.max(r,a)-Math.min(r,a))/2,h=Math.min(r,a)+(Math.max(r,a)-Math.min(r,a))/2,a>r&&(r+=CABLES.UI.uiConfig.portHeight),r>a&&(a+=CABLES.UI.uiConfig.portHeight),l=Math.min(i,s)+(Math.max(i,s)-Math.min(i,s))/4,u=Math.min(i,s)+(Math.max(i,s)-Math.min(i,s))/4;Math.min(i,s)+Math.abs(s-i);return l=i-0,u=s+0,"M "+i+" "+r+" C "+l+" "+c+" "+u+" "+h+" "+s+" "+a},this.isVisible=function(){return null!==i.linkLine},i.hide=function(){this.isVisible()&&(this.linkLine.remove(),this.linkLine=null)},i.show=function(){this.isVisible()||this.redraw()},this.remove=function(){i.hide()},this.redraw=function(){this.linkLine||(this.linkLine=gui.patch().getPaper().path(this.getPath()),this.linkLine.attr(CABLES.UI.uiConfig.linkingLine),this.linkLine.attr({stroke:CABLES.UI.uiConfig.getPortColor(e.thePort)})),this.linkLine.attr("path",this.getPath()),this.linkLine.toFront(),this.showAddButton()},this.setEnabled=function(e){e?this.linkLine.attr("opacity",1):this.linkLine.attr("opacity",.3)}}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function isNumber(e){return!isNaN(e-0)&&null!==e&&""!==e&&e!==!1}var CABLES=CABLES||{};CABLES.API=function(){function e(e,t,i,n,o){$.ajax({method:e,url:"/api/"+t,data:i}).done(function(e){n&&n(e)}).fail(function(e){CABLES&&CABLES.UI&&CABLES.UI.MODAL&&("NOT_LOGGED_IN"==e.statusText?CABLES.UI.MODAL.showError("not logged in",'<br/>you are not logged in, so you can not save projects, or upload files. so all will be lost :/<br/><br/><br/><a class="bluebutton" href="/signup">sign up</a> <a class="bluebutton" style="background-color:#222" onclick="CABLES.UI.MODAL.hide()">continue</a> <br/><br/> '):CABLES.UI.MODAL.show("ajax error: "+e.statusText)),o&&o(e.responseJSON)}).always(function(){})}this.get=function(t,i,n){e("GET",t,{},i,n)},this.post=function(t,i,n,o){e("POST",t,i,n,o)},this["delete"]=function(t,i,n,o){e("DELETE",t,i,n,o)},this.put=function(t,i,n,o){e("PUT",t,i,n,o)}},CABLES.api||(CABLES.api=new CABLES.API),window.onerror=function(e,t,i){var n="";n+='<h2><span class="fa fa-exclamation-triangle"></span> cablefail :/</h2>',n+="error:"+e+"<br/>",n+="<br/>",n+="file: "+t+"<br/>",n+="row: "+i+"<br/>",CABLES.UI.MODAL.show(n)},CABLES.UI=CABLES.UI||{},CABLES.UI.setStatusText=function(e){$("#statusbar").html("&nbsp;"+e)},CABLES.UI.showPreview=function(e,t,i){var n=gui.scene().getOpById(e);if(!n)return void console.log("opid not found:",e);var o=n.getPort(t);return o?(o.doShowPreview(i),void(i||(CGL.Texture.previewTexture=null))):void console.log("port not found:",t)},CABLES.UI.togglePortValBool=function(e,t){var i="true"==$("#"+e).val();i=!i,i?($("#"+t).addClass("fa-check-square-o"),$("#"+t).removeClass("fa-square-o")):($("#"+t).addClass("fa-square-o"),$("#"+t).removeClass("fa-check-square-o")),$("#"+e).val(i),$("#"+e).trigger("input")},CABLES.UI.inputIncrement=function(e,t){if("true"==e)return"false";if("false"==e)return"true";var i=parseFloat(e),n=.1,o=i+n*t;return o=isNaN(o)?0:Math.round(1e3*o)/1e3},Handlebars.registerHelper("json",function(e){return JSON.stringify(e)}),Handlebars.registerHelper("console",function(e){return console.log(e)}),Handlebars.registerHelper("compare",function(e,t,i,n){var o,r;if(arguments.length<4)throw new Error("Handlerbars Helper 'compare' needs 3 parameters, left value, operator and right value");if(o={"==":function(e,t){return e==t},"===":function(e,t){return e===t},"!=":function(e,t){return e!=t},"<":function(e,t){return t>e},">":function(e,t){return e>t},"<=":function(e,t){return t>=e},">=":function(e,t){return e>=t},"typeof":function(e,t){return typeof e==t}},!o[t])throw new Error("Handlerbars Helper 'compare' doesn't know the operator "+t);return r=o[t](e,i),r===!0?n.fn(this):n.inverse(this)}),CABLES=CABLES||{},CABLES.UI=CABLES.UI||{},CABLES.UI.MODAL=CABLES.UI.MODAL||{},CABLES.UI.MODAL.hide=function(){mouseNewOPX=0,mouseNewOPY=0,$("#modalcontent").html(""),$("#modalcontent").hide(),$("#modalbg").hide(),$(".tooltip").hide()},CABLES.UI.MODAL.show=function(e){$("#modalcontent").html('<div class="modalclose"><a class="button fa fa-times" onclick="CABLES.UI.MODAL.hide();"></a></div>'),$("#modalcontent").append(e),$("#modalcontent").show(),$("#modalbg").show(),$("#modalbg").on("click",function(){CABLES.UI.MODAL.hide()})},CABLES.UI.MODAL.showLoading=function(e,t){$("#modalcontent").html('<div style="text-align:center;"><h3>'+e+'</h3><i class="fa fa-4x fa-cog fa-spin"></i><br/><br/><div>'),$("#modalcontent").append(t),$("#modalcontent").show(),$("#modalbg").show()},CABLES.UI.MODAL.showError=function(e,t){$("#modalcontent").html('<div class="modalclose"><a class="button fa fa-times" onclick="CABLES.UI.MODAL.hide();"></a></div>'),$("#modalcontent").append('<h2><span class="fa fa-exclamation-triangle"></span>&nbsp;'+e+"</h2>"),$("#modalcontent").append(t),$("#modalcontent").show(),$("#modalbg").show(),$("#modalbg").on("click",function(){CABLES.UI.MODAL.hide()})},CABLES=CABLES||{},CABLES.UI=CABLES.UI||{},CABLES.UI.OPSELECT=CABLES.UI.OPSELECT||{},CABLES.UI.OPSELECT.linkNewLink=null,CABLES.UI.OPSELECT.linkNewOpToPort=null,CABLES.UI.OPSELECT.linkNewOpToOp=null,CABLES.UI.OPSELECT.newOpPos={x:0,y:0},CABLES.UI.OPSELECT.showOpSelect=function(e,t,i,n){function o(e){s=0,a(0)}CABLES.UI.OPSELECT.linkNewLink=n,CABLES.UI.OPSELECT.linkNewOpToPort=i,CABLES.UI.OPSELECT.linkNewOpToOp=t,CABLES.UI.OPSELECT.newOpPos=e;var r=CABLES.UI.getHandleBarHtml("op_select",{ops:CABLES.UI.OPSELECT.getOpList()});CABLES.UI.MODAL.show(r),$("#opsearch").focus(),$("#opsearch").on("input",function(e){var t=$("#opsearch").val();$("#search_style").html(t?'.searchable:not([data-index*="'+t.toLowerCase()+'"]) { display: none; }':".searchable:{display:block;}")}),$(".searchresult:first").addClass("selected");var s=0,a=function(e){s+=e,0>s&&(s=0);var t=$(".searchresult:visible"),i=$(".searchresult");s>=t.length&&(s=0),0>s&&(s=t.length-1);var n="selected";i.removeClass(n),t.removeClass(n).eq(s).addClass(n)};$("#opsearch").on("input",o),$("#opsearch").keydown(function(e){switch(e.which){case 13:var t=$(".selected").data("opname");gui.scene().addOp(t),CABLES.UI.MODAL.hide();break;case 8:return o(),!0;case 37:break;case 38:$(".selected").removeClass("selected"),a(-1);break;case 39:break;case 40:$(".selected").removeClass("selected"),a(1);break;default:return}e.preventDefault()}),setTimeout(function(){$("#opsearch").focus()},100)},CABLES.UI.OPSELECT.getOpList=function(){function getop(val,parentname){if("[object Object]"===Object.prototype.toString.call(val))for(var propertyName in val)if(val.hasOwnProperty(propertyName)){var html="",opname="Ops."+parentname+propertyName,isOp=!1,isFunction=!1;if("function"==eval("typeof("+opname+")")&&(isFunction=!0),isFunction){var op={isOp:isOp,name:opname,lowercasename:opname.toLowerCase()};ops.push(op)}found=getop(val[propertyName],parentname+propertyName+".")}}var ops=[];return getop(Ops,""),ops.sort(function(e,t){return e.name.length-t.name.length}),ops};var CABLES=CABLES||{};CABLES.UI=CABLES.UI||{},CABLES.UI.Patch=function(e){function t(){L=null,v=null,C&&C.hide()}function i(){var e="";e+=d.length+" ops selected / [del] delete ops / [a] align ops / [g] show grapghs ",CABLES.UI.setStatusText(e)}function n(e){if(1==e.buttons&&!p){L||(l.patch().setSelectedOp(null),L=l.patch().getCanvasCoordsMouse(e)),console.log("rubber!"),v=l.patch().getCanvasCoordsMouse(e),C||(C=a.paper.rect(0,0,10,10).attr({})),C.show();var t={x:L.x,y:L.y},n={x:v.x,y:v.y};if(n.x-t.x<0){var o=t.x;t.x=n.x,n.x=o}if(n.y-t.y<0){var r=t.y;t.y=n.y,n.y=r}C.attr({x:t.x,y:t.y,width:n.x-t.x,height:n.y-t.y,stroke:CABLES.UI.uiConfig.colorRubberBand,fill:CABLES.UI.uiConfig.colorRubberBand,"stroke-width":2,"fill-opacity":.1});for(var s in a.ops)if(!a.ops[s].isHidden()){var c=a.ops[s].oprect.getRect();if(c&&c.matrix){var u=c.matrix.e,h=c.matrix.f,f=c.attr("width"),g=c.attr("height");u>t.x&&u<n.x&&h>t.y&&h<n.y||u+f>t.x&&u+f<n.x&&h+g>t.y&&h+g<n.y?(a.addSelectedOp(a.ops[s]),a.ops[s].setSelected(!0)):(a.removeSelectedOp(a.ops[s]),a.ops[s].setSelected(!1))}}0===d.length?CABLES.UI.setStatusText(""):i()}}function o(e){var t=e.op;if(!E){(function(e,i){CABLES.undo.add({undo:function(){l.scene().deleteOp(e,!0)},redo:function(){l.scene().addOp(i,t.uiAttribs,e)}})})(t.id,t.objName)}t.onAddPort=function(i){e.addPort(i.direction,i),e.setPos(t.uiAttribs.translate.x,t.uiAttribs.translate.y)},t.uiAttribs&&t.uiAttribs.subPatch&&t.uiAttribs.subPatch!=f&&e.hide();for(var n in t.portsIn){var o=t.portsIn[n];o.uiAttribs||(o.uiAttribs={}),"readonly"!=o.uiAttribs.display&&e.addPort(PORT_DIR_IN,o),o.uiAttribs.hasOwnProperty("display")&&("dropdown"==o.uiAttribs.display&&(o.uiAttribs.type="string"),"file"==o.uiAttribs.display&&(o.uiAttribs.type="string"),"bool"==o.uiAttribs.display&&(o.uiAttribs.type="bool"))}for(var r in t.portsOut)e.addPort(PORT_DIR_OUT,t.portsOut[r]);if(t.uiAttribs||(t.uiAttribs={}),t.uiAttribs.translate||(t.uiAttribs.translate=0===CABLES.UI.OPSELECT.newOpPos.y&&0===CABLES.UI.OPSELECT.newOpPos.x?{x:g.x+g.w/2,y:g.y+g.h/2}:{x:CABLES.UI.OPSELECT.newOpPos.x,y:CABLES.UI.OPSELECT.newOpPos.y}),t.uiAttribs.hasOwnProperty("translate")&&e.setPos(t.uiAttribs.translate.x,t.uiAttribs.translate.y),t.uiAttribs.hasOwnProperty("title")&&l.patch().setOpTitle(e,t.uiAttribs.title),t.uiAttribs.hasOwnProperty("subPatch")||(t.uiAttribs.subPatch=f),CABLES.UI.OPSELECT.linkNewLink){console.log("add into link...");var s=CABLES.UI.OPSELECT.linkNewLink.p1.op,a=CABLES.UI.OPSELECT.linkNewLink.p1.thePort,c=CABLES.UI.OPSELECT.linkNewLink.p2.op,u=CABLES.UI.OPSELECT.linkNewLink.p2.thePort;for(var h in a.links)(a.links[h].portIn==a&&a.links[h].portOut==u||a.links[h].portOut==a&&a.links[h].portIn==u)&&a.links[h].remove();var p=t.findFittingPort(a),d=t.findFittingPort(u);d&&p&&(l.scene().link(t,p.getName(),s,a.getName()),l.scene().link(t,d.getName(),c,u.getName()))}else if(CABLES.UI.OPSELECT.linkNewOpToPort){var m=t.findFittingPort(CABLES.UI.OPSELECT.linkNewOpToPort);if(m){l.patch().scene.link(CABLES.UI.OPSELECT.linkNewOpToOp,CABLES.UI.OPSELECT.linkNewOpToPort.getName(),t,m.getName())}}e.setPos(t.uiAttribs.translate.x,t.uiAttribs.translate.y),CABLES.UI.OPSELECT.linkNewOpToOp=null,CABLES.UI.OPSELECT.linkNewLink=null,CABLES.UI.OPSELECT.linkNewOpToPort=null,CABLES.UI.OPSELECT.newOpPos={x:0,y:0},e.setPos(),E||setTimeout(function(){f==e.getSubPatch()&&e.show(),l.patch().setSelectedOp(null),l.patch().setSelectedOp(e),l.patch().showOpParams(t)},30),setTimeout(function(){e.op.uiAttribs.pasted&&(delete e.op.uiAttribs.pasted,l.patch().addSelectedOpById(e.op.id),e.setSelected(!0),i())},30),e.wasAdded=!0}function r(){h.op.uiAttribs.warning&&0!==h.op.uiAttribs.warning.length?($("#options_warning").show(),$("#options_warning").html(h.op.uiAttribs.warning)):$("#options_warning").hide(),h.op.uiAttribs.info?($("#options_info").show(),$("#options_info").html(h.op.uiAttribs.info)):$("#options_info").hide()}function s(){for(var e in c){var t=".watchPortValue_"+c[e].watchId;c[e].isAnimated()?$(t).val()!=c[e].val&&$(t).val(c[e].val):$(t).html(c[e].val)}CABLES.UI.uiConfig.watchValuesInterval>0&&setTimeout(s,CABLES.UI.uiConfig.watchValuesInterval)}var a=this;this.ops=[],this.scene=null;var l=e,c=[],u=null,h=null,p=!1,d=[],f=0,g={x:0,y:0,w:1100,h:1010},m=null,L=null,v=null,C=null,E=!1;this.isLoading=function(){return E},this.getPaper=function(){return a.paper},this.paste=function(e){if(e.clipboardData.types.indexOf("text/plain")>-1){var t=e.clipboardData.getData("text/plain");e.preventDefault();var i=JSON.parse(t);if(console.log("paste json",i),i&&i.ops){var n=0,o=0;for(n in i.ops){var r=i.ops[n].id,s=i.ops[n].id=generateUUID();i.ops[n].uiAttribs.pasted=!0;for(o in i.ops)if(i.ops[o].portsIn)for(var c in i.ops[o].portsIn)if(i.ops[o].portsIn[c].links){for(var u=i.ops[o].portsIn[c].links.length;u--;)console.log("json.ops[j].portsIn[k].links[l]",i.ops[o].portsIn[c].links[u]),null===i.ops[o].portsIn[c].links[u]&&(console.log("delete null link"),i.ops[o].portsIn[c].links.splice(u,1));for(var u in i.ops[o].portsIn[c].links)i.ops[o].portsIn[c].links[u].objIn==r&&(i.ops[o].portsIn[c].links[u].objIn=s),i.ops[o].portsIn[c].links[u].objOut==r&&(i.ops[o].portsIn[c].links[u].objOut=s)}}var h=[];for(n=0;n<i.ops.length;n++)if("Ops.Ui.Patch"==i.ops[n].objName)for(var c in i.ops[n].portsIn)if("patchId"==i.ops[n].portsIn[c].name){var p=parseInt(i.ops[n].portsIn[c].value,10),d=i.ops[n].portsIn[c].value=Ops.Ui.Patch.maxPatchId+1;for(console.log("oldSubPatchId",p),console.log("newSubPatchId",d),o=0;o<i.ops.length;o++)console.log("json.ops[j].uiAttribs.subPatch",i.ops[o].uiAttribs.subPatch),parseInt(i.ops[o].uiAttribs.subPatch,10)==p&&(console.log("found child patch"),i.ops[o].uiAttribs.subPatch=d,h.push(i.ops[o].id))}for(n in i.ops){var g=!1;for(o=0;o<h.length;o++)if(i.ops[n].id==h[o]){g=!0;break}g||(i.ops[n].uiAttribs.subPatch=f)}var L=Number.MAX_VALUE,v=Number.MAX_VALUE;for(n in i.ops)i.ops[n].uiAttribs&&i.ops[n].uiAttribs&&i.ops[n].uiAttribs.translate&&(L=Math.min(L,i.ops[n].uiAttribs.translate.x),v=Math.min(v,i.ops[n].uiAttribs.translate.y));for(n in i.ops)if(i.ops[n].uiAttribs&&i.ops[n].uiAttribs&&i.ops[n].uiAttribs.translate){var C=0,E=0;m&&(C=l.patch().getCanvasCoordsMouse(m).x,E=l.patch().getCanvasCoordsMouse(m).y),i.ops[n].uiAttribs.translate.x=i.ops[n].uiAttribs.translate.x+C-L,i.ops[n].uiAttribs.translate.y=i.ops[n].uiAttribs.translate.y+E-v}return CABLES.UI.setStatusText("pasted "+i.ops.length+" ops..."),a.setSelectedOp(null),void l.patch().scene.deSerialize(i)}CABLES.UI.setStatusText("paste failed / not cables data format...")}},this.cut=function(e){a.copy(e),a.deleteSelectedOps()},this.copy=function(e){var t=[],i=[],n=0,o=0,r=0;for(o in d)t.push(d[o].op.getSerialized()),i.push(d[o].op.id);for(o=0;o<t.length;o++)for(n=0;n<t[o].portsIn.length;n++)if(t[o].portsIn[n].links)for(r=t[o].portsIn[n].links.length;r--;)t[o].portsIn[n].links[r]&&t[o].portsIn[n].links[r].objIn&&t[o].portsIn[n].links[r].objOut&&(arrayContains(i,t[o].portsIn[n].links[r].objIn)&&arrayContains(i,t[o].portsIn[n].links[r].objOut)||(t[o].portsIn[n].links[r]=null));var s={ops:t},a=JSON.stringify(s);CABLES.UI.setStatusText("copied "+d.length+" ops..."),e.clipboardData.setData("text/plain",a),e.preventDefault()},$("#patch").keyup(function(e){switch(e.which){case 32:p=!1}}),$("#patch").keydown(function(e){switch(e.which){case 32:p=!0;break;case 46:case 8:if($("input").is(":focus"))return;a.deleteSelectedOps(),e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),a.showProjectParams();break;case 68:for(var t in d)d[t].setEnabled(!d[t].op.enabled);break;case 90:(e.metaKey||e.ctrlKey)&&(e.shiftKey?CABLES.undo.redo():CABLES.undo.undo());break;case 65:e.metaKey||e.ctrlKey?a.selectAllOps():e.shiftKey?a.alignSelectedOpsHor():a.alignSelectedOpsVert();break;case 71:a.showSelectedOpsGraphs();break;case 49:a.setCurrentSubPatch(0)}}),this.exportStatic=function(){CABLES.UI.MODAL.showLoading("exporting project"),CABLES.api.get("project/"+u._id+"/export",function(e){var t="";e.error?(t="<h2>export error</h2>",t+='<div class="shaderErrorCode">'+JSON.stringify(e)+"<div>"):(t="<h2>export finished</h2>",t+="size: "+e.size+" mb",t+="<br/><br/><br/>",t+='<a class="bluebutton" href="'+e.path+'">download</a>',t+="<br/><br/>",t+="<pre>"+e.log+"<pre>"),CABLES.UI.MODAL.show(t)})},this.saveCurrentProject=function(e,t,i){CABLES.UI.MODAL.showLoading("saving project"),l.patch().scene.cgl.doScreenshot=!0;var n=u._id,o=u.name;t&&(n=t),i&&(o=i),setTimeout(function(){var t=l.patch().scene.serialize(!0);t.ui={viewBox:{}},t.ui.viewBox.w=g.w,t.ui.viewBox.h=g.h,t.ui.viewBox.x=g.x,t.ui.viewBox.y=g.y,t.ui.renderer={},t.ui.renderer.w=l.rendererWidth,t.ui.renderer.h=l.rendererHeight,t=JSON.stringify(t),console.log("data.length",t.length),CABLES.api.put("project/"+n,{name:o,data:t,screenshot:l.patch().scene.cgl.screenShotDataURL},function(t){CABLES.UI.setStatusText(t.success===!0?"project saved":"project NOT saved"),CABLES.UI.MODAL.hide(),e&&e()})},30)},this.getCurrentProject=function(){return u},this.setCurrentProject=function(e){a.timeLine&&a.timeLine.clear(),u=e,null===u?($("#serverproject").hide(),$("#projectfiles").hide()):($("#projectfiles").show(),$("#serverproject").show(),$("#serverprojectname").html(e.name),a.updateProjectFiles(e),$(".viewProjectLink").attr("href","/view/"+e._id))},this.updateProjectFiles=function(e){e||(e=u),$("#projectfiles").html(""),CABLES.api.get("project/"+u._id+"/files",function(t){e.files=t;var i="";i+=CABLES.UI.getHandleBarHtml("tmpl_projectfiles_list",e),i+=CABLES.UI.getHandleBarHtml("tmpl_projectfiles_upload",e),$("#projectfiles").html(i)})},this.updateViewBox=function(){isNaN(g.x)||isNaN(g.y)||isNaN(g.w)||isNaN(g.h)||a.paper.setViewBox(g.x,g.y,g.w,g.h)},this.selectAllOpsSubPatch=function(e){for(var t in a.ops)a.ops[t].getSubPatch()==e&&(a.addSelectedOp(a.ops[t]),a.ops[t].setSelected(!0));i()},this.selectAllOps=function(){this.selectAllOpsSubPatch(f)},this.setProject=function(e){e.ui&&(e.ui.viewBox&&(g.x=e.ui.viewBox.x,g.y=e.ui.viewBox.y,g.w=e.ui.viewBox.w,g.h=e.ui.viewBox.h),e.ui.renderer&&(l.rendererWidth=e.ui.renderer.w,l.rendererHeight=e.ui.renderer.h,l.setLayout())),a.updateViewBox(),f=0,a.setCurrentProject(e),l.scene().clear(),l.scene().deSerialize(e),CABLES.undo.clear(),CABLES.UI.MODAL.hide(),a.updateSubPatches()},this.show=function(e){this.scene=e,$("#timing").append(CABLES.UI.getHandleBarHtml("timeline_controler"),{}),$("#meta").append(),this.paper=Raphael("patch",0,0),this.bindScene(a.scene),g={x:0,y:0,w:$("#patch svg").width(),h:$("#patch svg").height()},a.updateViewBox(),$("#patch svg").bind("mousewheel",function(e,t,i){t=CABLES.UI.getWheelSpeed(e),e=mouseEvent(e),g.w-t>0&&g.h-t>0&&(g.x+=t/2,g.y+=t/2,g.w-=t,g.h-=t),a.updateViewBox()});var i=a.paper.rect(-99999,-99999,199998,199998).attr({fill:CABLES.UI.uiConfig.colorBackground,"stroke-width":0});i.toBack(),i.node.onmousedown=function(e){$("#library").hide(),$("#patch").focus(),l.patch().setSelectedOp(null),a.showProjectParams()},$("#patch").on("mousemove",function(e){if(1==e.buttons&&!p){for(var t in a.ops)if(!a.ops[t].isHidden()&&(a.ops[t].isDragging||a.ops[t].isMouseOver))return;n(e)}}),$("#patch svg").bind("mouseup",function(e){t()}),$("#patch svg").bind("mousemove",function(e){if(e=mouseEvent(e),L&&1!=e.buttons&&t(),2==e.buttons||3==e.buttons||1==e.buttons&&p){var i=l.patch().getCanvasCoordsMouse(m).x,n=l.patch().getCanvasCoordsMouse(m).y;g.x+=i-l.patch().getCanvasCoordsMouse(e).x,g.y+=n-l.patch().getCanvasCoordsMouse(e).y,a.updateViewBox()}m=e}),this.timeLine=new CABLES.TL.UI.TimeLineUI,l.setLayout()},this.bindScene=function(e){e.onLoadStart=function(){E=!0},e.onLoadEnd=function(){E=!1,a.setCurrentSubPatch(f)},e.onUnLink=function(t,i){for(var n in a.ops){a.ops[n].removeDeadLinks();for(var o in a.ops[n].links)if(a.ops[n].links[o].p1.thePort==t&&a.ops[n].links[o].p2.thePort==i||a.ops[n].links[o].p1.thePort==i&&a.ops[n].links[o].p2.thePort==t){{(function(t,i,n,o){CABLES.undo.add({undo:function(){e.link(e.getOpById(n),t,e.getOpById(o),i)},redo:function(){var r=e.getOpById(n),s=e.getOpById(o);return r&&s?void r.getPortByName(t).removeLinkTo(s.getPortByName(i)):void console.warn("undo: op not found")}})})(a.ops[n].links[o].p1.thePort.getName(),a.ops[n].links[o].p2.thePort.getName(),a.ops[n].links[o].p1.thePort.parent.id,a.ops[n].links[o].p2.thePort.parent.id)}a.ops[n].links[o].hideAddButton(),a.ops[n].links[o].p1=null,a.ops[n].links[o].p2=null,a.ops[n].links[o].remove()}}},e.onLink=function(t,i){var n=null,o=null;for(var r in a.ops){for(var s in a.ops[r].portsIn)a.ops[r].portsIn[s].thePort==t&&(n=a.ops[r].portsIn[s]),a.ops[r].portsIn[s].thePort==i&&(o=a.ops[r].portsIn[s]);for(var l in a.ops[r].portsOut)a.ops[r].portsOut[l].thePort==t&&(n=a.ops[r].portsOut[l]),a.ops[r].portsOut[l].thePort==i&&(o=a.ops[r].portsOut[l])}var c=new UiLink(n,o);n.opUi.links.push(c),o.opUi.links.push(c),n.opUi.isHidden()||c.show();!function(t,i,n,o){CABLES.undo.add({undo:function(){var r=e.getOpById(n),s=e.getOpById(o);return r&&s?void r.getPortByName(t).removeLinkTo(s.getPortByName(i)):void console.warn("undo: op not found")},redo:function(){e.link(e.getOpById(n),t,e.getOpById(o),i)}})}(t.getName(),i.getName(),t.parent.id,i.parent.id)},e.onDelete=function(e){!function(t,i){CABLES.undo.add({undo:function(){l.scene().addOp(t,e.uiAttribs,i)},redo:function(){l.scene().deleteOp(i,!1)}})}(e.objName,e.id);for(var t in a.ops)a.ops[t].op==e&&(a.ops[t].hideAddButtons(),a.ops[t].remove(),a.ops.splice(t,1))},e.onAdd=function(e){$("#patch").focus();var t=new OpUi(a.paper,e,CABLES.UI.OPSELECT.newOpPos.x,CABLES.UI.OPSELECT.newOpPos.y,100,31,e.name);a.ops.push(t),t.wasAdded=!1,o(t)}},this.setOpTitle=function(e,t){e.op.uiAttribs.title=t,e.op.name=t,e.oprect.setTitle(t)},this.setCurrentOpTitle=function(e){h&&this.setOpTitle(h,e)},this.updateSubPatches=function(){if(!E)for(var e in a.ops)a.ops[e].op.uiAttribs.subPatch||(a.ops[e].op.uiAttribs.subPatch=0),a.ops[e].op.uiAttribs.subPatch==f?a.ops[e].show():a.ops[e].hide()},this.getCurrentSubPatch=function(){return f},this.setCurrentSubPatch=function(e){0===e?$("#button_subPatchBack").hide():$("#button_subPatchBack").show(),f=e,a.updateSubPatches(),$("#patch").focus()},this.showSelectedOpsGraphs=function(){l.timeLine().clear();var e=!0,t=0;if(d.length>0)for(var i=0;i<d.length;i++)for(var n=0;n<d[i].portsIn.length;n++)d[i].portsIn[n].thePort.isAnimated()&&d[i].portsIn[n].thePort.anim&&(0===t&&(e=!d[i].portsIn[n].thePort.anim.stayInTimeline),d[i].portsIn[n].thePort.anim.stayInTimeline=e,a.timeLine.setAnim(d[i].portsIn[n].thePort.anim),t++);e||l.timeLine().clear()},this.alignSelectedOpsVert=function(){if(d.length>0){var e=0,t=0;for(e in d)t+=d[e].op.uiAttribs.translate.x;var i=t/d.length;for(e in d)d[e].setPos(i,d[e].op.uiAttribs.translate.y)}},this.alignSelectedOpsHor=function(){if(d.length>0){var e=0,t=0;for(e in d)t+=d[e].op.uiAttribs.translate.y;var i=t/d.length;for(e in d)d[e].setPos(d[e].op.uiAttribs.translate.x,i)}},this.deleteSelectedOps=function(){for(var e in d)l.patch().scene.deleteOp(d[e].op.id,!0)},this.removeSelectedOp=function(e){for(var t in d)if(d[t]==e)return void d.splice(t,1)},this.setSelectedOpById=function(e){for(var t in l.patch().ops)if(l.patch().ops[t].op.id==e)return l.patch().setSelectedOp(null),l.patch().setSelectedOp(l.patch().ops[t]),void l.patch().showOpParams(l.patch().ops[t].op)},this.addSelectedOpById=function(e){for(var t in l.patch().ops)if(l.patch().ops[t].op.id==e)return a.addSelectedOp(l.patch().ops[t]),void console.log("found sel op by id !")},this.setSelectedOp=function(e){if(null!==e)a.addSelectedOp(e),e.setSelected(!0);else{d.length=0;for(var t in l.patch().ops)l.patch().ops[t].setSelected(!1),l.patch().ops[t].hideAddButtons()}},this.addSelectedOp=function(e){"Ops.Ui.Patch"==e.op.objName&&a.selectAllOpsSubPatch(e.op.patchId.val),e.oprect.setSelected(!0);for(var t in d)if(d[t]==e)return;d.push(e)},this.moveSelectedOpsFinished=function(){for(var e in d)d[e].doMoveFinished()},this.moveSelectedOps=function(e,t,i,n,o){for(var r in d)d[r].doMove(e,t,i,n,o)},this.updateOpParams=function(e){a.showOpParams(l.scene().getOpById(e))},this.showProjectParams=function(e){var t={};t.name=u.name,t.settings=l.scene().settings;var i=0;for(var n in a.ops)a.ops[n].isHidden()||i++;var o=CABLES.UI.getHandleBarHtml("params_project",{project:t,debug:{numOps:l.scene().ops.length,numVisibleOps:i,numSvgElements:$("#patch svg *").length}});$("#options").html(o)},this.saveProjectParams=function(){var e=$("#projectsettings_name").val(),t=$("#projectsettings_public").val();u.name=e,l.scene().settings=l.scene().settings||{},l.scene().settings.isPublic=t},this.showOpParams=function(e){if(h&&(h.onUiAttrChange=null),a.timeLine){var t=!1;for(var i in e.portsIn)e.portsIn[i].isAnimated()&&(a.timeLine.setAnim(e.portsIn[i].anim,{name:e.portsIn[i].name}),t=!0);t||a.timeLine.setAnim(null)}for(var n in this.ops)this.ops[n].op==e&&(h=this.ops[n]);h.op.onUiAttrChange=r,c=[],watchAnimPorts=[],watchColorPicker=[];var o=CABLES.UI.getHandleBarHtml("params_op_head",{op:e}),s=$("#params_port").html(),u=Handlebars.compile(s);o+=CABLES.UI.getHandleBarHtml("params_ports_head",{title:"in"});for(var i in e.portsIn)e.portsIn[i].watchId="in_"+i,watchAnimPorts.push(e.portsIn[i]),e.portsIn[i].uiAttribs.colorPick&&watchColorPicker.push(e.portsIn[i]),(e.portsIn[i].isLinked()||e.portsIn[i].isAnimated())&&c.push(e.portsIn[i]),o+=u({port:e.portsIn[i],dirStr:"in",portnum:i,isInput:!0,op:e});o+=CABLES.UI.getHandleBarHtml("params_ports_head",{title:"out",op:e});for(var p in e.portsOut)e.portsOut[p].getType()==OP_PORT_TYPE_VALUE&&(e.portsOut[p].watchId="out_"+p,c.push(e.portsOut[p])),o+=u({port:e.portsOut[p],dirStr:"out",portnum:p,isInput:!1,op:e});o+=CABLES.UI.getHandleBarHtml("params_op_foot",{op:e}),$("#options").html(o),r();for(var d in e.portsOut)!function(t){$("#portdelete_out_"+t).on("click",function(i){e.portsOut[t].removeLinks(),a.showOpParams(e)})}(d);for(var f in e.portsIn)!function(t){e.portsIn[t].isAnimated()&&$("#portanim_in_"+t).addClass("timingbutton_active"),e.portsIn[t].isAnimated()&&e.portsIn[t].anim.stayInTimeline&&$("#portgraph_in_"+t).addClass("timingbutton_active"),$("#portgraph_in_"+t).on("click",function(i){e.portsIn[t].isAnimated()&&(e.portsIn[t].anim.stayInTimeline=!e.portsIn[t].anim.stayInTimeline,$("#portgraph_in_"+t).toggleClass("timingbutton_active"),a.timeLine.setAnim(e.portsIn[t].anim,{name:e.portsIn[t].name,defaultValue:parseFloat($("#portval_"+t).val())}))}),$("#portanim_in_"+t).on("click",function(i){if($("#portanim_in_"+t).hasClass("timingbutton_active")){var n=a.timeLine.removeAnim(e.portsIn[t].anim);return e.portsIn[t].setAnimated(!1),a.timeLine.setAnim(null),$("#portanim_in_"+t).removeClass("timingbutton_active"),$("#portval_"+t).val(n),$("#portval_"+t).trigger("input"),void $("#portval_"+t).focus()}$("#portanim_in_"+t).addClass("timingbutton_active"),e.portsIn[t].toggleAnim(),a.timeLine.setAnim(e.portsIn[t].anim,{name:e.portsIn[t].name,defaultValue:parseFloat($("#portval_"+t).val())})})}(f);for(var g in e.portsIn)!function(t){$("#portdelete_in_"+t).on("click",function(i){e.portsIn[t].removeLinks(),a.showOpParams(e)})}(g);for(var m in e.portsIn)!function(t){$("#portval_"+t).on("input",function(i){var n=""+$("#portval_"+t).val();if(!e.portsIn[t].uiAttribs.type||"number"==e.portsIn[t].uiAttribs.type){if(isNaN(n)||""===n)return void $("#portval_"+t).addClass("invalid");$("#portval_"+t).removeClass("invalid")}if("int"==e.portsIn[t].uiAttribs.type){if(isNaN(n)||""===n)return void $("#portval_"+t).addClass("invalid");$("#portval_"+t).removeClass("invalid"),n=parseInt(n,10)}"bool"==e.portsIn[t].uiAttribs.display&&("true"!=n&&"false"!=n&&(n=!1,$("#portval_"+t).val("false")),n="true"==n?!0:!1),e.portsIn[t].val=n,e.portsIn[t].isAnimated()&&(console.log("is animatedddd"),l.timeLine().scaleHeightDelayed())})}(m);for(var L in watchAnimPorts){var v=watchAnimPorts[L];!function(e){var t=".watchPortValue_"+e.watchId;$(t).on("focusin",function(){e.isAnimated()&&l.timeLine().setAnim(e.anim,{name:e.name})})}(v)}for(var C in watchColorPicker){var v=watchColorPicker[C];!function(e){var t="#watchcolorpick_"+e.watchId,i=Math.round(255*$(t).parent().next("td").find("input.value").val()),n=Math.round(255*$(t).parent().parent().next("tr").find("input.value").val()),o=Math.round(255*$(t).parent().parent().next("tr").next("tr").find("input.value").val());$(t).css("background-color","rgb("+i+","+n+","+o+")"),$(t).colorPicker({opacity:!0,margin:"4px -2px 0",doRender:"div div",renderCallback:function(e){var i=this.color.colors;$(t).parent().next("td").find("input.value").val(i.rgb.r).trigger("input"),$(t).parent().parent().next("tr").find("input.value").val(i.rgb.g).trigger("input"),$(t).parent().parent().next("tr").next("tr").find("input.value").val(i.rgb.b).trigger("input"),$(t).parent().next("td").find("input.range").val(i.rgb.r).trigger("input"),$(t).parent().parent().next("tr").find("input.range").val(i.rgb.g).trigger("input"),$(t).parent().parent().next("tr").next("tr").find("input.range").val(i.rgb.b).trigger("input"),modes={r:Math.round(255*i.rgb.r),g:Math.round(255*i.rgb.g),b:Math.round(255*i.rgb.b),h:i.hsv.h,s:i.hsv.s,v:i.hsv.v,HEX:this.color.colors.HEX},$("input",".cp-panel").each(function(){this.value=modes[this.className.substr(3)]})},buildCallback:function(e){var t=this.color,i=this;e.prepend('<div class="cp-panel">R <input type="text" class="cp-r" /><br>G <input type="text" class="cp-g" /><br>B <input type="text" class="cp-b" /><hr>H <input type="text" class="cp-h" /><br>S <input type="text" class="cp-s" /><br>B <input type="text" class="cp-v" /><hr><input type="text" class="cp-HEX" /></div>').on("change","input",function(e){
var n=this.value,o=this.className,r=o.split("-")[1],s={};s[r]=n,t.setColor("HEX"===r?n:s,"HEX"===r?"HEX":/(?:r|g|b)/.test(r)?"rgb":"hsv"),i.render(),this.blur()})}})}(v)}},this.getCanvasCoordsMouse=function(e){var t=$("#patch svg")[0].getScreenCTM();t=t.inverse();var i=$("#patch svg")[0].createSVGPoint();i.x=e.clientX,i.y=e.clientY,i=i.matrixTransform(t);var n={x:i.x,y:i.y};return n},this.addAssetOp=function(e,t,i){var n,o={title:i,translate:{x:g.x+g.w/2,y:g.y+g.h/2}};".obj"==t?(n=l.scene().addOp("Ops.Gl.Meshes.ObjMesh",o),n.getPort("file").val=e):".png"==t||".jpg"==t?(n=l.scene().addOp("Ops.Gl.Texture",o),n.getPort("file").val=e):".mp3"==t||".ogg"==t?(n=l.scene().addOp("Ops.WebAudio.AudioPlayer",o),n.getPort("file").val=e):CABLES.UI.setStatusText("unknown file type")},s()};var CABLES=CABLES||{};CABLES.UI=CABLES.UI||{},Raphael.el.setGroup=function(e){this.group=e},Raphael.el.getGroup=function(){return this.group};var OpRect=function(e,t,i,n,o,r,s){function a(){L.isMouseOver=!0}function l(){L.isMouseOver=!1}var c=!0,u=Raphael.fn.set(),h=null,p=null,d=n,f=o,g=t,m=i,L=e,v=r;this.getRect=function(){return h},this.isVisible=function(){return null!==p},this.removeUi=function(){this.isVisible()&&(u.clear(),h.remove(),p.remove(),p=null,h=null)},this.getWidth=function(){return d},this.setWidth=function(e){d=e,this.isVisible()&&h.attr({width:d})};var C=function(e,t,i){$("#patch").focus(),L.isSelected()||(L.showAddButtons(),i.shiftKey||gui.patch().setSelectedOp(null),gui.patch().setSelectedOp(L))},E=function(e,t,i,n,o){gui.patch().moveSelectedOps(e,t,i,n,o)},S=function(){gui.patch().moveSelectedOpsFinished(),gui.patch().showOpParams(L.op)};this.addUi=function(){this.isVisible()||(h=gui.patch().getPaper().rect(0,0,d,f).attr({fill:CABLES.UI.uiConfig.colorOpBg,stroke:CABLES.UI.uiConfig.colorPatchStroke,"stroke-width":0,cursor:"move"}),p=gui.patch().getPaper().text(0+d/2,0+f/2+0,v),$(p.node).css({"pointer-events":"none"}),h.drag(E,C,S),h.hover(a,l),h.node.ondblclick=function(e){gui.patch().setSelectedOp(null),"Ops.Ui.Patch"==L.op.objName&&gui.patch().setCurrentSubPatch(L.op.patchId.val)},h.onmouseup=function(e){L.isDragging=!1},"Ops.Ui.Patch"==s&&h.attr({"stroke-width":4,stroke:CABLES.UI.uiConfig.colorPatchStroke}),u.push(h,p))},this.setEnabled=function(e){this.isVisible()&&h.attr(e?{"fill-opacity":1}:{"fill-opacity":.5})},this.setSelected=function(e){c=e,this.isVisible()&&h.attr(e?{fill:CABLES.UI.uiConfig.colorOpBgSelected}:{fill:CABLES.UI.uiConfig.colorOpBg})},this.setTitle=function(e){v=e,p&&p.attr({text:v})},this.getGroup=function(){return u},u.transform("t"+g+","+m)},OpUi=function(e,t,i,n,o,r,s){var a=this;this.links=[],this.portsIn=[],this.portsOut=[];var l=!1;this.op=t;var c=!1,u="",h=-1,p=-1,d=0,f=0;this.isMouseOver=!1,this.remove=function(){this.oprect.getGroup().remove(),this.oprect.removeUi()},this.getSubPatch=function(){return t.uiAttribs.subPatch?t.uiAttribs.subPatch:0},this.isSelected=function(){return c},this.hide=function(){l=!0,this.oprect.removeUi(),this.oprect.getGroup().hide();var e=0;for(e in a.portsIn)a.portsIn[e].removeUi();for(e in a.portsOut)a.portsOut[e].removeUi();for(e in a.links)a.links[e].hide(),a.links[e].hideAddButton()},this.show=function(){l=!1,this.oprect.addUi(),this.oprect.getGroup().show();var e=0;for(e in a.portsIn)a.portsIn[e].addUi(this.oprect.getGroup());for(e in a.portsOut)a.portsOut[e].addUi(this.oprect.getGroup());for(e in a.links)a.links[e].show();a.setPos()},this.isHidden=function(){return l},this.removeDeadLinks=function(){for(var e=!0;e;){e=!1;for(var t in a.links)null===a.links[t].p1&&(a.links.splice(t,1),e=!0)}},this.showAddButtons=function(){if(!this.isHidden()){a.removeDeadLinks();for(var e in a.links)a.links[e].showAddButton()}},this.hideAddButtons=function(){a.removeDeadLinks();for(var e in a.links)a.links[e].hideAddButton()},this.doMoveFinished=function(){CABLES.undo.add({undo:function(){try{var e=JSON.parse(u);a.setPos(e.translate.x,e.translate.y)}catch(t){}},redo:function(){}}),h=-1,p=-1,a.isDragging=!1},this.setPos=function(e,t){isNumber(e)&&(d=e,f=t),a.oprect.getGroup()&&a.oprect.getGroup().transform("t"+d+","+f),a.op.uiAttribs.translate={x:d,y:f};for(var i in a.links)a.links[i].redraw()},this.doMove=function(e,t,i,n,o){if(3!=o.which&&2!=o.which){o=mouseEvent(o);var r=gui.patch().getCanvasCoordsMouse(o);a.op.uiAttribs||(a.op.uiAttribs={},a.op.uiAttribs.translate={x:r.x,y:r.y}),-1==h&&a.op.uiAttribs.translate&&(u=JSON.stringify(a.op.uiAttribs),h=r.x-a.op.uiAttribs.translate.x,p=r.y-a.op.uiAttribs.translate.y),r.x=r.x-h,r.y=r.y-p;var s=10,l=r.x%65-s;l>0&&s>l&&(r.x-=l),0>l&&l>-s&&(r.x-=l),l=r.y%50-s,l>0&&s>l&&(r.y-=l),0>l&&l>-s&&(r.y-=l),a.setPos(r.x,r.y),a.isDragging=!0}},this.oprect=new OpRect(this,i,n,o,r,s,a.op.objName),this.setEnabled=function(e){this.op.enabled=e,this.oprect.setEnabled(e);for(var t=0;t<this.links.length;t++)this.links[t].setEnabled(e)},this.setSelected=function(e){c=e,e?a.showAddButtons():a.hideAddButtons(),a.isDragging=!1,this.oprect.setSelected(e)},this.addPort=function(e,t){var i=e,n=this.portsIn.length;i==PORT_DIR_OUT&&(n=this.portsOut.length);var o=(CABLES.UI.uiConfig.portSize+CABLES.UI.uiConfig.portPadding)*n;a.oprect.getWidth()<o+CABLES.UI.uiConfig.portSize&&a.oprect.setWidth(o+CABLES.UI.uiConfig.portSize);var r=new CABLES.UI.Port(t);r.direction=i,r.op=a.op,r.opUi=a,r.portIndex=n,this.oprect.getRect()&&r.addUi(this.oprect.getGroup()),i==PORT_DIR_OUT?this.portsOut.push(r):this.portsIn.push(r)}};CABLES.UI.Port=function(e){function t(){for(var e=0;e<a.opUi.links.length;e++)(a.opUi.links[e].p1.thePort==a.thePort||a.opUi.links[e].p2.thePort==a.thePort)&&a.opUi.links[e].setEnabled(a.thePort.getUiActiveState())}function i(e,t,i){$("#patch").focus(),u||(this.startx=this.matrix.e+this.attrs.x,this.starty=this.matrix.f+this.attrs.y)}function n(e,t,i,n,o){if(3!=o.which&&2!=o.which&&(a.thePort.direction!=PORT_DIR_IN||!a.thePort.isLinked()&&!a.thePort.isAnimated())){if(u?(a.opUi.isDragging=!0,o=mouseEvent(o),u.updateEnd(gui.patch().getCanvasCoordsMouse(o).x,gui.patch().getCanvasCoordsMouse(o).y)):u=new Line(this.startx+CABLES.UI.uiConfig.portSize/2,this.starty+CABLES.UI.uiConfig.portHeight),selectedEndPort&&selectedEndPort.thePort){var r=Link.canLinkText(selectedEndPort.thePort,a.thePort);CABLES.UI.setStatusText("can link"==r?getPortDescription(selectedEndPort.thePort):r),r="can link"==r?'<i class="fa fa-check"></i>':'<i class="fa fa-times"></i> '+r,CABLES.UI.showToolTip(o,r+" "+getPortDescription(selectedEndPort.thePort))}else CABLES.UI.setStatusText("select a port to link...");u.thisLine.attr(selectedEndPort&&selectedEndPort.thePort&&Link.canLink(selectedEndPort.thePort,a.thePort)?{stroke:CABLES.UI.uiConfig.colorLink}:{stroke:CABLES.UI.uiConfig.colorLinkInvalid})}}function o(e){if(3==e.which)return void a.thePort.removeLinks();if(selectedEndPort&&selectedEndPort.thePort&&Link.canLink(selectedEndPort.thePort,a.thePort)){var t=gui.patch().scene.link(selectedEndPort.op,selectedEndPort.thePort.getName(),a.op,a.thePort.getName());if(t){var i=new UiLink(selectedEndPort,a);selectedEndPort.opUi.links.push(i),a.opUi.links.push(i)}}else e=mouseEvent(e),selectedEndPort&&selectedEndPort.thePort&&u||CABLES.UI.OPSELECT.showOpSelect(gui.patch().getCanvasCoordsMouse(e),a.op,a.thePort);u&&u.thisLine&&u.thisLine.remove(),u=null,a.opUi.isDragging=!1}function r(t){selectedEndPort=a,a.rect.toFront(),a.rect.attr({x:l-.25*CABLES.UI.uiConfig.portSize,y:c-.25*CABLES.UI.uiConfig.portSize,width:1.5*CABLES.UI.uiConfig.portSize,height:1.5*CABLES.UI.uiConfig.portSize,"stroke-width":0});var i=getPortDescription(e);CABLES.UI.setStatusText(i),CABLES.UI.showToolTip(t,i)}function s(){CABLES.UI.hideToolTip(),selectedEndPort=null;var e=0;a.direction==PORT_DIR_OUT&&(e=CABLES.UI.uiConfig.portSize-CABLES.UI.uiConfig.portHeight),a.rect.attr({fill:CABLES.UI.uiConfig.getPortColor(a.thePort),"fill-opacity":getPortOpacity(a.thePort),width:CABLES.UI.uiConfig.portSize,height:CABLES.UI.uiConfig.portHeight,x:l,y:c+e,"stroke-width":0}),CABLES.UI.setStatusText("")}var a=this;this.thePort=null,this.rect=null,this.portIndex=0,this.thePort=e,this.opUi=null;var l=0,c=0,u=null;this.isVisible=function(){return null!==this.rect},this.removeUi=function(){a.isVisible()&&(this.rect.undrag(),this.rect.unhover(r,s),this.rect.remove(),this.rect=null,e.onUiActiveStateChange=null)},this.addUi=function(u){if(e.onUiActiveStateChange=t,!a.isVisible()&&!a.opUi.isHidden()){var h=0,p=0,d=(CABLES.UI.uiConfig.portSize+CABLES.UI.uiConfig.portPadding)*a.portIndex;a.direction==PORT_DIR_OUT&&(p=CABLES.UI.uiConfig.portSize-CABLES.UI.uiConfig.portHeight,h=21),l=0+d,c=0+h,this.rect=gui.patch().getPaper().rect(l,p+c,CABLES.UI.uiConfig.portSize,CABLES.UI.uiConfig.portHeight).attr({"stroke-width":0,fill:CABLES.UI.uiConfig.getPortColor(a.thePort),"fill-opacity":getPortOpacity(a.thePort)}),u.push(this.rect),$(a.rect.node).bind("contextmenu",function(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.cancelBubble=!1}),a.rect.hover(r,s),a.rect.drag(n,i,o)}}};var pingDelay=1e4,windowUUID=guid(),delay=pingDelay,hasFailed=!1,ping=function(){$.ajax({url:"/api/ping/"+windowUUID+"/editor"}).done(function(){delay=pingDelay,hasFailed&&CABLES.UI.setStatusText("connection to server ESTABLISHED..."),hasFailed=!1}).fail(function(){delay=2*pingDelay,hasFailed=!0,CABLES.UI.setStatusText("connection to server lost...")}),setTimeout(ping,delay)};ping(),CABLES=CABLES||{},CABLES.UI=CABLES.UI||{},CABLES.UI.FileSelect=function(){var e="",t="",i="",n="",o="";this.setTab=function(n){"projectfiles"==n&&(t="/assets/"+gui.patch().getCurrentProject()._id,i="project/"+gui.patch().getCurrentProject()._id+"/files/"),"library"==n&&(t="/assets/library/",i="library/"),$("#tab_"+e).removeClass("active"),e=n,this.load()},this.showPreview=function(e){console.log("val",e);var t={};(e.endsWith(".jpg")||e.endsWith(".png"))&&(t.previewImageUrl=e);var i=CABLES.UI.getHandleBarHtml("library_preview",t);$("#lib_preview").html(i)},this.show=function(e,t){if($("#library").toggle(),$("#library").is(":visible")){$("#lib_head").html(CABLES.UI.getHandleBarHtml("library_head")),n=e,o=t,this.load();var i=$(e).val();this.showPreview(i)}},this.load=function(){function r(e,i,o){o||(o=t);var s="";for(var a in i)if(i[a]){if(i[a].selectableClass="",!i[a].d)if(i[a].t==e)i[a].selectableClass="selectable";else{if("image"==e)continue;i[a].selectableClass="unselectable"}i[a].p||(i[a].p=o+i[a].n),s+=CABLES.UI.getHandleBarHtml("library_file",{file:i[a],inputId:n,filterType:e}),i[a].d&&(s+=r(e,i[a].c,o+i[a].n+"/"))}return s}return""===e?void this.setTab("projectfiles"):($("#tab_"+e).addClass("active"),void CABLES.api.get(i,function(e){var t=r(o,e);$("#lib_files").html(t)}))}},CABLES.UI.fileSelect=new CABLES.UI.FileSelect,CABLES=CABLES||{},CABLES.UI=CABLES.UI||{},CABLES.UI.SELECTPROJECT=CABLES.UI.SELECTPROJECT||{},CABLES.UI.SELECTPROJECT.projectsHtml=null,CABLES.UI.SELECTPROJECT.doReload=!0,CABLES.UI.SELECTPROJECT.showSelectProjects=function(e){function t(e){i=0,n(0)}CABLES.UI.MODAL.show(e),$("#projectsearch").focus(),$("#projectsearch").on("input",function(e){var t=$("#projectsearch").val();$("#search_style").html(t?'.searchable:not([data-index*="'+t.toLowerCase()+'"]) { display: none; }':".searchable:{display:block;}")}),$(".searchresult:first").addClass("selected");var i=0,n=function(e){i+=e,0>i&&(i=0);var t=$(".searchresult:visible"),n=$(".searchresult");i>=t.length&&(i=0),0>i&&(i=t.length-1);var o="selected";n.removeClass(o),t.removeClass(o).eq(i).addClass(o)};$("#projectsearch").on("input",t),$("#projectsearch").keydown(function(e){switch(e.which){case 13:var i=$(".selected").data("projid");document.location.href="#/project/"+i;break;case 8:return t(),!0;case 37:break;case 39:break;default:return}e.preventDefault()}),setTimeout(function(){$("#projectsearch").focus()},100)},CABLES.UI.SELECTPROJECT.show=function(){!CABLES.UI.SELECTPROJECT.projectsHtml||CABLES.UI.SELECTPROJECT.doReload?CABLES.api.get("myprojects",function(e){CABLES.UI.MODAL.showLoading("loading projectlist..."),CABLES.UI.SELECTPROJECT.projectsHtml=CABLES.UI.getHandleBarHtml("select_project",{projects:e}),CABLES.UI.SELECTPROJECT.showSelectProjects(CABLES.UI.SELECTPROJECT.projectsHtml),CABLES.UI.SELECTPROJECT.doReload=!1}):CABLES.UI.SELECTPROJECT.showSelectProjects(CABLES.UI.SELECTPROJECT.projectsHtml)};var min=300,max=3600,mainmin=200;$(document).ready(function(){$("#splitterPatch").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault(),gui.rendererWidth=window.innerWidth-e.clientX,gui.setLayout()})}),$("#splitterRenderer").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault(),gui.rendererHeight=e.clientY,gui.setLayout()})}),$("#splitterTimeline").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault(),gui.timingHeight=window.innerHeight-e.clientY,gui.setLayout()})}),$("#splitterRendererWH").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault(),gui.rendererWidth=window.innerWidth-e.clientX,gui.rendererHeight=e.clientY,gui.setLayout()})}),$(document).mouseup(function(e){$(document).unbind("mousemove")})}),CABLES.TL.UI=CABLES.TL.UI||{},CABLES.TL.Key.prototype.isUI=!0,CABLES.TL.Key.prototype.circle=null,CABLES.TL.Key.prototype.circleBezierOut=null,CABLES.TL.Key.prototype.circleBezierIn=null,CABLES.TL.Key.prototype.selected=!1,CABLES.TL.Key.prototype.showCircle=!0,CABLES.TL.MultiGraphKeyDisplayMode=!0,CABLES.TL.MoveMode=0,CABLES.TL.TIMESCALE=100,CABLES.TL.VALUESCALE=100,CABLES.TL.Key.prototype.setAttribs=function(e){var t=.7,i="#222";this.isMainAnim&&(i=CABLES.UI.uiConfig.colorKey,t=.8),this.circle.attr({"fill-opacity":.7}),this.circle.attr({cx:this.x,cy:this.y,"fill-opacity":t,fill:i}),this.selected&&this.circle.attr({fill:"white"})},CABLES.TL.Key.prototype.setSelected=function(e){this.selected=e,this.setAttribs()},CABLES.TL.Key.prototype.removeUi=function(){this.bezierControlLineOut&&(this.bezierControlLineOut.undrag(),this.bezierControlLineOut.remove(),this.bezierControlLineOut=!1),this.bezierControlLineIn&&(this.bezierControlLineIn.undrag(),this.bezierControlLineIn.remove(),this.bezierControlLineIn=!1),this.circleBezierOut&&(this.circleBezierOut.undrag(),this.circleBezierOut.remove(),this.circleBezierOut=!1),this.circleBezierIn&&(this.circleBezierIn.undrag(),this.circleBezierIn.remove(),this.circleBezierIn=!1),this.circle&&(this.circle.undrag(),this.circle.remove(),this.circle=!1)},CABLES.TL.Key.prototype.isMainAnim=!1,CABLES.TL.Key.prototype.updateCircle=function(e){if(void 0!==e&&(this.isMainAnim=e),gui.timeLine()){if(this.circle||this.initUI(),this.getEasing()!=CABLES.TL.EASING_BEZIER||this.circleBezierOut||this.initUI(),isNaN(this.value)&&(this.value=0),this.x=this.time*CABLES.TL.TIMESCALE,this.y=this.value*-CABLES.TL.VALUESCALE,this.showCircle?this.circle.show():this.circle.hide(),this.getEasing()==CABLES.TL.EASING_BEZIER){var t=this.x+this.bezTime*CABLES.TL.TIMESCALE,i=this.y+this.bezValue*CABLES.TL.VALUESCALE;this.circleBezierOut.attr({cx:t,cy:i});var n=this.x+this.bezTimeIn*CABLES.TL.TIMESCALE,o=this.y+this.bezValueIn*CABLES.TL.VALUESCALE;this.circleBezierIn.attr({cx:n,cy:o});var r="M "+this.x+" "+this.y+" L "+t+" "+i,s="M "+this.x+" "+this.y+" L "+n+" "+o;this.bezierControlLineOut.attr({path:r,stroke:"#888","stroke-width":1}),this.bezierControlLineIn.attr({path:s,stroke:"#888","stroke-width":1})}isNaN(this.x)&&(this.x=0,console.log("key this.x NaN")),isNaN(this.y)&&(this.y=0,console.log("key this.x NaN")),this.setAttribs(),this.isMainAnim&&this.circle.toFront()}},CABLES.TL.Key.prototype.initUI=function(){function e(e,t,i,n,o){$("#timeline").focus(),a.isDragging=!0,a.selected||(gui.timeLine().unselectKeys(),a.setSelected(!0)),gui.timeLine().moveSelectedKeys(e,t,i,n,o)}function t(){a.isDragging||(c=a.getSerialized()),a.isDragging=!0}function i(){gui.timeLine().moveSelectedKeysFinished(),CABLES.undo.add({undo:function(){a.set(c),gui.timeLine().refresh()},redo:function(){}}),a.isDragging=!1}function n(e,t,i,n,o){a.isDragging=!0;var r=gui.timeLine().getCanvasCoordsMouse(o),s=gui.timeLine().getTimeFromPaper(r.x),l=a.time,c=a.value,u=r.y/CABLES.TL.VALUESCALE;a.setBezierControlOut(s-l,u+c),a.updateCircle()}function o(){a.isDragging=!1,a.x=-1,a.y=-1}function r(e,t,i,n,o){a.isDragging=!0;var r=gui.timeLine().getCanvasCoordsMouse(o),s=gui.timeLine().getTimeFromPaper(r.x),l=a.time,c=a.value,u=r.y/CABLES.TL.VALUESCALE;a.setBezierControlIn(s-l,u+c),a.updateCircle()}function s(){a.isDragging=!1,a.x=-1,a.y=-1}if(gui.timeLine()){var a=this;this.x=this.time*CABLES.TL.TIMESCALE,this.y=this.value*-CABLES.TL.VALUESCALE,this.bezX=this.x+this.bezTime*CABLES.TL.TIMESCALE,this.bezY=this.y+this.bezValue*CABLES.TL.VALUESCALE;var l={fill:CABLES.UI.uiConfig.colorKey,stroke:"none"};this.circle&&this.removeUi(),this.getEasing()==CABLES.TL.EASING_BEZIER&&(this.circleBezierOut||(this.circleBezierOut=gui.timeLine().getPaper().circle(this.bezX,this.bezY,7)),this.circleBezierOut.attr({fill:"#fff","fill-opacity":.7}),this.circleBezierIn||(this.circleBezierIn=gui.timeLine().getPaper().circle(this.bezXIn,this.bezYIn,7)),this.circleBezierIn.attr({fill:"#f00","fill-opacity":.7}),this.bezierControlLineOut||(this.bezierControlLineOut=gui.timeLine().getPaper().path("M 0 0 ")),this.bezierControlLineIn||(this.bezierControlLineIn=gui.timeLine().getPaper().path("M 0 0 "))),this.circle=gui.timeLine().getPaper().circle(this.x,this.y,7),this.circle.attr(l),this.circle.toFront(),this.circle.node.onclick=function(e){$("#timeline").focus(),e.shiftKey||gui.timeLine().unselectKeys(),a.setSelected(e.shiftKey&&a.selected?!1:!0)};var c={},u=-1,h=-1;this.doMoveFinished=function(){u=-1,h=-1,a.isDragging=!1},this.doMove=function(e,t,i,n,o,r){if(this.showCircle){-1==u&&(u=r.x-a.x,h=r.y-a.y),r.x=r.x-u,r.y=r.y-h;var s=gui.timeLine().getTimeFromPaper(r.x),l=parseInt((s+.5/gui.timeLine().getFPS())*gui.timeLine().getFPS(),10);s=l/gui.timeLine().getFPS(),0===CABLES.TL.MoveMode&&a.set({time:s,value:a.value}),1==CABLES.TL.MoveMode&&a.set({time:s,value:r.y/-CABLES.TL.VALUESCALE}),2==CABLES.TL.MoveMode&&a.set({time:s,value:r.y/-CABLES.TL.VALUESCALE})}},this.circle.drag(e,t,i),a.circleBezierOut&&a.circleBezierOut.drag(n,o),a.circleBezierIn&&a.circleBezierIn.drag(r,s)}},CABLES.TL.Anim.prototype.hasSelectedKeys=function(){for(var e in this.keys)if(this.keys[e].selected)return!0},CABLES.TL.Anim.prototype.show=function(){gui.timeLine()&&(this.keyLine||(this.keyLine=gui.timeLine().getPaper().path("M 0 0 L 1 1")))},CABLES.TL.Anim.prototype.removeUi=function(){this.keyLine&&(this.keyLine.hide(),this.keyLine.remove(),this.keyLine=!1);for(var e in this.keys)this.keys[e].removeUi()},CABLES.TL.Anim.prototype.unselectKeys=function(){for(var e in this.keys)this.keys[e].setSelected(!1)},CABLES.TL.Anim.prototype.deleteKeyAt=function(e){for(var t in this.keys)if(this.keys[t].time==e)return this.keys[t].removeUi(),void this.keys.splice(t,1)},CABLES.TL.Anim.prototype.deleteSelectedKeys=function(){for(var e=!0;e;){e=!1;for(var t in this.keys)if(this.keys[t].selected&&this.keys[t].showCircle){{(function(e,t){CABLES.undo.add({undo:function(){e.addKey(new CABLES.TL.Key(t)),e.sortKeys(),gui.timeLine().refresh()},redo:function(){e.deleteKeyAt(t.t),gui.timeLine().refresh()}})})(this,this.keys[t].getSerialized())}this.keys[t].removeUi(),this.keys.splice(t,1),e=!0}}this.sortKeys()},CABLES.TL.UI.TimeLineUI=function(){function e(e){var t=parseInt(e*L,10);return t}function t(){for(var e in C)C[e].removeUi();$("#timeline svg circle").length>0&&console.log("KEYS NOT REMOVED PROPERLY")}function i(e){A&&l(e)}function n(e){0>e&&(e=0),isNaN(e)&&(e=0),v=e,e*=CABLES.TL.TIMESCALE,P.attr({path:"M "+e+" -1000 L"+e+" 1110"}),O.attr({path:"M "+e+" -1000 L"+e+" 1110"})}function o(){clearTimeout(x),x=setTimeout(r,10)}function r(){if(!gui.patch().isLoading())for(var e in C){var t=null,i=C[e];if(i&&0===i.keys.length)i.removeUi();else if(i){i.show(),i.sortKeys();for(var n=(m.x/CABLES.TL.TIMESCALE,m.w/CABLES.TL.TIMESCALE*1.2,[0]),r=0;r<i.keys.length;r++)if(n.push(i.keys[r].time-1e-5),n.push(i.keys[r].time),n.push(i.keys[r].time+1e-5),i.keys[r].getEasing()!=CABLES.TL.EASING_LINEAR&&i.keys[r].getEasing()!=CABLES.TL.EASING_ABSOLUTE&&r<i.keys.length-1)for(var s=i.keys[r+1].time-i.keys[r].time,a=0;s>a;a+=s/50)n.push(i.keys[r].time+a);n.push(1e3);for(var l=0;l<n.length;l++){var c=n[l],u=i.getValue(c);t+=null===t?"M ":"L ",t+=c*CABLES.TL.TIMESCALE+" "+u*-CABLES.TL.VALUESCALE}for(var r=0;r<i.keys.length;r++){var h=null;i.keys.length>r+1&&(h=i.keys[r+1]),i.keys[r].showCircle=CABLES.TL.MultiGraphKeyDisplayMode?!0:i==g?!0:!1,i.keys[r].updateCircle(i==g),null===i.keys[r].onChange&&(i.keys[r].onChange=o)}i.keyLine.attr({path:t}),i.keyLine&&i.keyLine.attr(i==g?{stroke:"#fff","stroke-width":2}:{stroke:"#222","stroke-width":1})}}}function s(){CABLES.TL.MoveMode++,CABLES.TL.MoveMode>2&&(CABLES.TL.MoveMode=0),0===CABLES.TL.MoveMode&&($("#keymovemode").addClass("fa-arrows-h"),$("#keymovemode").removeClass("fa-arrows-v"),$("#keymovemode").removeClass("fa-arrows")),1==CABLES.TL.MoveMode&&($("#keymovemode").addClass("fa-arrows-v"),$("#keymovemode").removeClass("fa-arrows-h"),$("#keymovemode").removeClass("fa-arrows")),2==CABLES.TL.MoveMode&&($("#keymovemode").addClass("fa-arrows"),$("#keymovemode").removeClass("fa-arrows-v"),$("#keymovemode").removeClass("fa-arrows-h"))}function a(e){if(3==e.buttons){t();for(var i=0;i<C.length;i++)console.log("anims[i]",C[i]),d.removeAnim(C[i]);d.setAnim(null),r()}else CABLES.TL.MultiGraphKeyDisplayMode=!CABLES.TL.MultiGraphKeyDisplayMode,console.log("CABLES.TL.MultiGraphKeyDisplayMode ",CABLES.TL.MultiGraphKeyDisplayMode);r()}function l(e){if(1==e.buttons||2==e.buttons){A=!0,e.offsetX=e.clientX;var t=d.getTimeFromMouse(e),i=parseInt((t+.5/L)*L,10);t=i/L,gui.scene().timer.setTime(t),d.updateTime(),$("#timeline").focus()}}function c(){for(var e in C)for(var t in C[e].keys)if(C[e].keys[t].isDragging===!0)return!0;return!1}function u(){var e=5*L;e=L+L/4,CABLES.TL.TIMESCALE>30&&(e=L/2),CABLES.TL.TIMESCALE>60&&(e=L/3),CABLES.TL.TIMESCALE>300&&(e=L/6),CABLES.TL.TIMESCALE>500&&(e=L/10),CABLES.TL.TIMESCALE>1e3&&(e=L/30);for(var t=0;100>t;t++){var i,n=t*e;t>R.length-1&&(i=S.text(10,-80,""),R.push(i));var o=parseInt(n,10);T||(o=(""+t*e/L).substr(0,4)+"s "),i=R[t],i.attr({text:""+o,x:t*e/L*CABLES.TL.TIMESCALE,y:-190,fill:"#aaa","font-size":12})}}function h(){b=null,I=null,w&&w.attr({x:0,y:0,width:0,height:0,"stroke-width":0,"fill-opacity":0})}function p(e){if(1==e.buttons&&!M){b||(b=d.getCanvasCoordsMouse(e)),I=d.getCanvasCoordsMouse(e),w||(w=E.rect(0,0,10,10).attr({}));var t={x:b.x,y:b.y},i={x:I.x,y:I.y};if(i.x-t.x<0){var n=t.x;t.x=i.x,i.x=n}if(i.y-t.y<0){var o=t.y;t.y=i.y,i.y=o}if(w.attr({x:t.x,y:t.y,width:i.x-t.x,height:i.y-t.y,stroke:CABLES.UI.uiConfig.colorRubberBand,fill:CABLES.UI.uiConfig.colorRubberBand,"stroke-width":2,"fill-opacity":.1}),!y)return;var r=0;for(var s in C)for(var a in C[s].keys){var l=C[s].keys[a].circle;if(C[s].keys[a].showCircle){var c=l.attr("cx"),u=l.attr("cy");C[s].keys[a].setSelected(!1),c>t.x&&c<i.x&&u>t.y&&u<i.y&&(C[s].keys[a].setSelected(!0),r++)}}CABLES.UI.setStatusText(r+" keys selected")}}var d=this,f=new CABLES.TL.Anim,g=null,m={x:-10,y:-170,w:1200,h:400},L=30,v=0,C=[],E=Raphael("timeline",0,0),S=Raphael("timetimeline",0,0),A=!1,y=!1,B=!1,b=null,I=null,w=null,k=null,T=!0,P=E.path("M 0 0 L 10 10");P.attr({stroke:CABLES.UI.uiConfig.colorCursor,"stroke-width":2});var O=S.path("M 0 0 L 10 10");O.attr({stroke:CABLES.UI.uiConfig.colorCursor,"stroke-width":2}),this.getFPS=function(){return L},this.getPaper=function(){return E},this.addAnim=function(e){if(null!==e){var t=0;e.show();for(var i=!0;i;){i=!1;for(t in C)i||C[t].stayInTimeline||C[t]==e||(console.log("found one! "+t),C[t].removeUi(),1==C.length?C.length=0:C=C.slice(t,1),i=!0)}C.push(e)}},this.removeAnim=function(e){if(e){var i=e.getValue(v);e.stayInTimeline=!1;for(var n in C)if(C[n]&&C[n]==e)return e.removeUi(),C=C.slice(n,1),d.addAnim(f),t(),r(),this.refresh(),i;return 0}},this.getAnim=function(){return g},this.setAnim=function(e,n){if(gui.timeLine()){if($(document).bind("mousemove",i),e&&e!=f&&gui.showTiming(),t(),!e||null===e)return g=f,t(),r(),$("#timelineTitle").html(""),void(y=!1);e.paper=E,g=e,y=!0,this.addAnim(g),$("#timelineTitle").html(n&&n.name?n.name:""),n&&n.hasOwnProperty("defaultValue")&&0===g.keys.length&&(g.keys.push(new CABLES.TL.Key({time:v,value:n.defaultValue})),this.centerCursor()),r(),g.keyLine&&g.keyLine.toFront();for(var s in g.keys)g.keys[s].circle||g.keys[s].initUI(),g.keys[s].updateCircle(!0);null===g.onChange&&(g.onChange=o)}};var U=E.path("M 0 0 L 111000 0");U.attr({stroke:"#999","stroke-width":1}),this.updateViewBox=function(){y||t(),E.setViewBox(m.x,m.y,$("#timeline").width(),m.h,!1),S.setViewBox(m.x,-200,$("#timeline").width(),400,!1),m.w=$("#timeline").width(),S.canvas.setAttribute("preserveAspectRatio","xMinYMin slice"),E.canvas.setAttribute("preserveAspectRatio","xMinYMin slice"),r()},this.refresh=function(){o()};var x=0;this.getCanvasCoordsMouse=function(e){return this.getCanvasCoordsSVG("#timeline svg",e)},this.getCanvasCoordsMouseTimeDisplay=function(e){return this.getCanvasCoordsSVG("#timetimeline svg",e)},this.gotoOffset=function(e){gui.scene().timer.setOffset(e),d.updateTime(),d.isCursorVisible()||d.centerCursor()},this.gotoZero=function(){gui.scene().timer.setTime(0),n(0),d.centerCursor()},this.getCanvasCoordsSVG=function(e,t){var i=$(e)[0].getScreenCTM();i=i.inverse();var n=$(e)[0].createSVGPoint();n.x=t.clientX,n.y=t.clientY,n=n.matrixTransform(i);var o={x:n.x,y:n.y};return o};var M=!1;this.jumpKey=function(e){var t=null;for(var i in C){var n=C[i].getKeyIndex(v),o=parseInt(n,10)+parseInt(e,10);if(1==o&&v<C[i].keys[0].time&&(o=0),o==C[i].keys.length-2&&v>C[i].keys[C[i].keys.length-1].time&&(o=C[i].keys.length-1),C[i].keys.length>o&&o>=0){var r=C[i].keys[o].time;t||(t=C[i].keys[o]),Math.abs(v-r)<Math.abs(v-t.time)&&(t=C[i].keys[o])}}t&&(gui.scene().timer.setTime(t.time),d.updateTime(),(t.time>this.getTimeRight()||t.time<this.getTimeLeft())&&this.centerCursor())},$("#timeline").keyup(function(e){switch(e.which){case 32:M=!1}}),$("#timeline").keydown(function(t){switch(t.which){case 46:case 8:for(var i in C)C[i].deleteSelectedKeys();r(),t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault();break;case 32:M=!0;break;case 72:d.scaleHeight(),d.scaleWidth();break;case 65:(t.metaKey||t.ctrlKey)&&d.selectAllKeys();break;case 68:console.log("anim.keys",g.keys);break;case 90:(t.metaKey||t.ctrlKey)&&(t.shiftKey?CABLES.undo.redo():CABLES.undo.undo());break;case 37:var n=1;t.shiftKey&&(n=10);var o=e(d.getTime()-1/L*n+.001);gui.scene().timer.setTime(o/L);break;case 39:var n=1;t.shiftKey&&(n=10);var o=e(d.getTime()+1/L*n+.001);gui.scene().timer.setTime(o/L);break;default:console.log("key ",t.which)}}),this.getTimeLeft=function(){return m.x/CABLES.TL.TIMESCALE},this.getTimeRight=function(){return this.getTimeLeft()+m.w/CABLES.TL.TIMESCALE},this.toggleLoop=function(){g.loop=!g.loop,r()},this.centerCursor=function(){var e=v*CABLES.TL.TIMESCALE,t=m.w,i=e-t/2;0>i&&(i=0),m.x=i,d.updateViewBox(),u()},this.scaleWidth=function(){if(!gui.patch().isLoading()){var e=-99999,t=99999999,i=!1;for(var n in C)C[n].hasSelectedKeys()&&(i=!0);var o=0;for(var n in C)for(var r in C[n].keys)(!i||C[n].keys[r].selected)&&(o++,e=Math.max(e,C[n].keys[r].time),t=Math.min(t,C[n].keys[r].time));0===o&&(e=10,t=10),e==t&&(e+=3,t-=3,0>t&&(t=0)),CABLES.TL.TIMESCALE=m.w/(e-t)*.9,m.x=t*CABLES.TL.TIMESCALE-.05*(e-t)*CABLES.TL.TIMESCALE,console.log("CABLES.TL.TIMESCALE ",t,e,o),d.updateViewBox(),u()}};var D=0;this.scaleHeightDelayed=function(){clearTimeout(D),D=setTimeout(d.scaleHeight,150)};var _=0,H=0;this.scaleHeight=function(){var e=-99999,t=99999999,i=!1;for(var n in C)C[n].hasSelectedKeys()&&(i=!0);var o=0;for(var n in C)for(var r in C[n].keys)(!i||C[n].keys[r].selected)&&(o++,e=Math.max(e,C[n].keys[r].value),t=Math.min(t,C[n].keys[r].value));if(_!=e||H!=t){_=e,H=t,0===o&&(e=1,t=-1),e==t&&(e+=2,t-=2);var s=Math.abs(e)+Math.abs(t);d.setValueScale($("#timeline").height()/2.3/(s-.2*Math.abs(s))),m.y=1.1*-e*CABLES.TL.VALUESCALE,d.updateViewBox()}},this.selectAllKeys=function(){for(var e in C)for(var t in C[e].keys)C[e].keys[t].showCircle&&C[e].keys[t].setSelected(!0);r()},this.setSelectedKeysEasing=function(e){for(var t in C){C[t].defaultEasing=e;for(var i in C[t].keys)C[t].removeUi(),C[t].keys[i].selected&&C[t].keys[i].setEasing(e)}r()},$("#keymovemode").bind("click",s),$("#keyscaleheight").bind("click",this.scaleHeight),$("#keyscalewidth").bind("click",this.scaleWidth),$("#loop").bind("click",this.toggleLoop),$("#centercursor").bind("click",this.centerCursor),$("#centercursor").bind("mousedown",function(){B=!0}),$("#centercursor").bind("mouseup",function(){B=!1}),$("#toggleMultiGraphKeyDisplay").bind("mousedown",a),$(".timeLineInsert").bind("click",function(e){g.keys.push(new CABLES.TL.Key({paper:E,time:v,value:g.getValue(v)})),r()});var j=0;$("#timeline").bind("mousedown",function(e){j=Date.now()}),$("#timeline").bind("mouseup",function(e){Date.now()-j<100&&!e.shiftKey&&!A&&!c()&&d.unselectKeys(),h();for(var t in C)for(var i in C[t].keys)C[t].keys[i].isDragging=!1}),$("#timetimeline").bind("mouseup",function(e){A=!1}),window.addEventListener("resize",function(e){d.updateViewBox()}),$(document).bind("mouseup",function(e){A=!1}),$("#timelineui").bind("mousedown",function(e){$("#timeline").focus(),"INPUT"!=e.target.nodeName&&e.preventDefault()}),$("#timetimeline").bind("mousedown",function(e){$(document).bind("mousemove",i),$("#timeline").focus(),e=mouseEvent(e),l(e),e.preventDefault()});var N=0,z=0;$("#timeline").bind("mousemove",function(e){if(!A){if(e=mouseEvent(e),2==e.buttons||3==e.buttons||1==e.buttons&&M){m.x+=N-d.getCanvasCoordsMouse(e).x,m.y+=z-d.getCanvasCoordsMouse(e).y;{m.x/CABLES.TL.TIMESCALE}d.updateViewBox()}N=d.getCanvasCoordsMouse(e).x,z=d.getCanvasCoordsMouse(e).y,c()||p(e)}});var R=[];this.getTime=function(){return v},this.setValueScale=function(e){CABLES.TL.VALUESCALE=e,r(),u()},this.setTimeScale=function(e){P.hide();var t=this.getTimeFromPaper(m.x),i=this.getPaperXFromTime(v);CABLES.TL.TIMESCALE=e,m.x=t*CABLES.TL.TIMESCALE/2;var o=this.getPaperXFromTime(v);m.x-=(i-o)/2,r(),d.updateViewBox(),u(),$("#timeline").focus(),P.show(),n(this.getTime())},this.getTimeFromMouse=function(e){var t=d.getCanvasCoordsMouseTimeDisplay(e).x;return t/=CABLES.TL.TIMESCALE},this.isCursorVisible=function(){return v>d.getTimeFromPaper(m.x)&&v<d.getTimeFromPaper(m.w)+d.getTimeFromPaper(m.x)},this.getPaperXFromTime=function(e){return e*CABLES.TL.TIMESCALE},this.getTimeFromPaper=function(e){var t=e;return t/=CABLES.TL.TIMESCALE},this.toggleTimeDisplayMode=function(){T=!T,console.log("timeDisplayMode",T),this.updateTime(),u()};var K=-1;this.updateTime=function(){var t=gui.scene().timer.getTime();n(t),B&&d.centerCursor(),K!=t&&(K=t,$(".timelinetime").html(T?'<b class="mainColor">'+e(t)+"</b><br/>"+(t+"").substr(0,4)+"s ":'<b class="mainColor">'+(t+"").substr(0,4)+"s </b><br/>"+e(t)+" ")),null===k&&(k=setInterval(d.updateTime,30))},this.togglePlay=function(e){gui.scene().timer.togglePlay(),gui.scene().timer.isPlaying()?($("#timelineplay").removeClass("fa-play"),$("#timelineplay").addClass("fa-pause"),this.updateTime()):($("#timelineplay").removeClass("fa-pause"),$("#timelineplay").addClass("fa-play"),this.updateTime())},this.copy=function(e){var t=[];for(var i in g.keys)g.keys[i].selected&&t.push(g.keys[i].getSerialized());var n={keys:t},o=JSON.stringify(n);CABLES.UI.setStatusText(t.length+" keys copied..."),e.clipboardData.setData("text/plain",o),e.preventDefault()},this.cut=function(e){y&&(d.copy(e),g.deleteSelectedKeys(),r())},this.paste=function(e){if(y&&e.clipboardData.types.indexOf("text/plain")>-1){e.preventDefault();var t=e.clipboardData.getData("text/plain");e.preventDefault();var i=JSON.parse(t);if(i&&i.keys){var n=0,o=Number.MAX_VALUE;

for(n in i.keys)o=Math.min(o,i.keys[n].t);CABLES.UI.setStatusText(i.keys.length+" keys pasted...");for(n in i.keys)i.keys[n].t=i.keys[n].t-o+v,g.addKey(new CABLES.TL.Key(i.keys[n]));g.sortKeys();for(n in g.keys)g.keys[n].updateCircle(!0);return void r()}CABLES.UI.setStatusText("paste failed / not cables data format...")}},this.moveSelectedKeysFinished=function(){for(var e in C)if(C[e])for(var t in C[e].keys){var i=C[e].keys[t];i.selected&&i.doMoveFinished()}},this.moveSelectedKeys=function(e,t,i,n,o){var r=gui.timeLine().getCanvasCoordsMouse(o);Math.abs(o.clientX-gui.timeLine().getTime()*CABLES.TL.TIMESCALE)<20&&(r.x=gui.timeLine().getTime()*CABLES.TL.TIMESCALE);for(var s in C)if(C[s])for(var a in C[s].keys){var l=C[s].keys[a];l.selected&&l.doMove(e,t,i,n,o,r)}},this.unselectKeys=function(){for(var e in C)C[e]&&C[e].unselectKeys()},this.clear=function(){for(var e in C)C[e].removeUi(),found=!0;C.length=0},this.updateTime(),this.setAnim(f),u(),this.centerCursor(),r(),this.setAnim(f),d.updateViewBox(),d.setAnim(f)},CABLES=CABLES||{},CABLES.UI=CABLES.UI||{},CABLES.UI.getHandleBarHtml=function(e,t){var i=$("#"+e).html(),n=Handlebars.compile(i),o=t;return n(o)},CABLES.UI.getWheelSpeed=function(e){var t;if(e.wheelDelta)t=e.wheelDelta%120-0==-0?e.wheelDelta/120:e.wheelDelta/12;else{var i=e.deltaY?e.deltaY:e.detail;t=-(i%3?10*i:i/3)}return t*-.2};var tooltipTimeout=null;CABLES.UI=CABLES.UI||{},CABLES.UI.showToolTip=function(e,t){$(".tooltip").show(),$(".tooltip").css("top",e.clientY+12),$(".tooltip").css("left",e.clientX+12),$(".tooltip").html(t)},CABLES.UI.hideToolTip=function(){$(".tooltip").hide()},$(document).on("mouseover mousemove",".tt",function(e){clearTimeout(tooltipTimeout);var t=$(this).data("tt");tooltipTimeout=setTimeout(function(){CABLES.UI.showToolTip(e,t)},300)}),$(document).on("mouseout",".tt",function(){clearTimeout(tooltipTimeout),CABLES.UI.hideToolTip()}),CABLES.UI=CABLES.UI||{},CABLES.undo=new UndoManager,CABLES.UI.GUI=function(){function e(){var e=new Simrou;e.addRoute("/").get(function(e,i){(!localStorage.holo||""===localStorage.holo||localStorage.holo.length<20)&&t.scene.clear(),t.patch().scene.deSerialize(localStorage.holo)}),e.addRoute("/project/:id").get(function(e,i){CABLES.UI.MODAL.showLoading("loading"),CABLES.api.get("project/"+i.id,function(e){t.patch().setProject(e)})}),e.start("/")}var t=this,i=!1,n=!1,o=new Scene;o.gui=!0;var r=null;this.timeLine=function(){return r.timeLine},this.scene=function(){return o},this.patch=function(){return r},this.timingHeight=250,this.rendererWidth=640,this.rendererHeight=360,this.setLayout=function(){(void 0===t.rendererWidth||void 0===t.rendererHeight||t.rendererWidth>.99*window.innerWidth||t.rendererHeight>.99*window.innerHeight)&&(t.rendererWidth=.4*window.innerWidth,t.rendererHeight=.25*window.innerHeight);var e=26,o=33,r=400,s=40,a=25,l=window.innerHeight-e-o-2,c=window.innerWidth-t.rendererWidth-8,u=0;if(i?(l=l-this.timingHeight-2,$(".easingselect").css("bottom",40),$(".easingselect").css("left",c+30)):l-=s,n){var h=30;$("#editor").show(),$("#editorbar").css("height",h),$("#editorbar").css("top",o+2),c/=2,u=c,$("#ace").css("height",l-2-h),$("#ace").css("width",c),$("#ace").css("top",o+2+h),$("#ace").css("left",0)}else $("#editor").hide();$("#patch svg").css("height",l-2),$("#patch svg").css("width",window.innerWidth-t.rendererWidth-9),$("#splitterPatch").css("left",window.innerWidth-t.rendererWidth-5),$("#splitterPatch").css("height",l+s+2),$("#splitterPatch").css("top",o),$("#splitterRenderer").css("top",t.rendererHeight),$("#splitterRenderer").css("width",t.rendererWidth),$("#splitterRendererWH").css("right",t.rendererWidth-35),$("#splitterRendererWH").css("top",t.rendererHeight-30),$("#patch").css("height",l-2),$("#patch").css("width",c),$("#patch").css("top",o+2),$("#patch").css("left",u),$("#timelineui").css("width",window.innerWidth-t.rendererWidth-2),$("#timing").css("width",window.innerWidth-t.rendererWidth-2),$("#timing").css("bottom",e),i?($("#timing").css("height",this.timingHeight),$("#timetimeline").css("width",window.innerWidth-t.rendererWidth-2),$("#timetimeline").css("height",this.timingHeight-a),$("#timetimeline").css("margin-top",s),$("#timetimeline svg").css("width",window.innerWidth-t.rendererWidth-2),$("#timetimeline svg").css("height",this.timingHeight-a-s-e),$("#timeline svg").css("width",window.innerWidth-t.rendererWidth-2),$("#timeline svg").css("height",this.timingHeight-a),$("#timeline svg").css("margin-top",s+a),$("#timeline svg").show(),$("#timetimeline").show(),$("#keycontrols").show(),$("#splitterTimeline").show(),$("#splitterTimeline").css("bottom",this.timingHeight-a+s+8)):($("#keycontrols").hide(),$("#timetimeline").hide(),$("#timeline svg").hide(),$("#timing").css("height",s),$("#splitterTimeline").hide()),t.timeLine()&&t.timeLine().updateViewBox(),$("#splitterTimeline").css("width",window.innerWidth-t.rendererWidth-2),$("#options").css("left",window.innerWidth-t.rendererWidth-1),$("#options").css("top",t.rendererHeight),$("#options").css("width",r),$("#options").css("height",window.innerHeight-t.rendererHeight-e),$("#meta").css("right",0),$("#meta").css("top",t.rendererHeight),$("#meta").css("width",t.rendererWidth-r),$("#meta").css("height",window.innerHeight-t.rendererHeight-e),$("#performance_glcanvas").css("bottom",e),$("#performance_glcanvas").css("right",t.rendererWidth-r-$("#performance_glcanvas").width()+1),$("#menubar").css("top",0),$("#menubar").css("width",window.innerWidth-t.rendererWidth-10),$("#menubar").css("height",o),0===t.rendererWidth?($("#glcanvas").attr("width",window.innerWidth),$("#glcanvas").attr("height",window.innerHeight),$("#glcanvas").css("z-index",9999)):($("#glcanvas").attr("width",t.rendererWidth),$("#glcanvas").attr("height",t.rendererHeight)),CABLES.UI.setStatusText("webgl renderer set to size: "+t.rendererWidth+" x "+t.rendererHeight)},this.importDialog=function(){var e="";e+="import:<br/><br/>",e+='<textarea id="serialized"></textarea>',e+="<br/>",e+="<br/>",e+='<a class="button" onclick="gui.patch().scene.clear();gui.patch().scene.deSerialize($(\'#serialized\').val());CABLES.UI.MODAL.hide();">import</a>',CABLES.UI.MODAL.show(e)},this.exportDialog=function(){var e="";e+="export:<br/><br/>",e+='<textarea id="serialized"></textarea>',CABLES.UI.MODAL.show(e),$("#serialized").val(t.patch().scene.serialize())};var s,a;this.cycleRendererSize=function(){console.log("cycleRendererSize"),0!==t.rendererWidth?(s=t.rendererWidth,a=t.rendererHeight,t.rendererWidth=0):(t.rendererWidth=s,t.rendererHeight=a),t.setLayout()},this.isShowingTiming=function(){return i},this.showTiming=function(){i=!0,t.setLayout()},this.toggleTiming=function(){i=!i,t.setLayout()},this.showLibrary=function(e,t){CABLES.UI.fileSelect.show(e,t)},this.createProject=function(){CABLES.api.post("project",{name:prompt("projectname","")},function(e){CABLES.UI.SELECTPROJECT.doReload=!0,document.location.href="#/project/"+e._id})},this.showHelp=function(){var e=CABLES.UI.getHandleBarHtml("help1");CABLES.UI.MODAL.show(e)},this.deleteCurrentProject=function(){confirm("delete ?")&&CABLES.api["delete"]("project/"+t.patch().getCurrentProject()._id,{},function(){CABLES.UI.SELECTPROJECT.doReload=!0})},this.bind=function(){$("#glcanvas").attr("tabindex","3"),$("#button_toggleTiming").bind("mousedown",function(e){t.toggleTiming()}),$("#button_cycleRenderSize").bind("mousedown",function(e){t.cycleRendererSize()}),$(".button_saveCurrentProject").bind("mousedown",function(e){t.patch().saveCurrentProject()}),$(".button_addOp").bind("mousedown",function(e){CABLES.UI.OPSELECT.showOpSelect({x:0,y:0})}),$("#button_subPatchBack").bind("click",function(e){t.patch().setCurrentSubPatch(0)}),$("#button_settings").bind("click",function(e){t.patch().showProjectParams()}),$("#help").bind("click",function(e){t.showHelp()}),window.addEventListener("resize",t.setLayout,!1),document.addEventListener("copy",function(e){$("#patch").is(":focus")&&t.patch().copy(e),$("#timeline").is(":focus")&&t.patch().timeLine.copy(e)}),document.addEventListener("paste",function(e){$("#patch").is(":focus")&&t.patch().paste(e),$("#timeline").is(":focus")&&t.patch().timeLine.paste(e)}),document.addEventListener("cut",function(e){$("#patch").is(":focus")&&t.patch().cut(e),$("#timeline").is(":focus")&&t.patch().timeLine.cut(e)});var e=0;$("#timeline, #patch").keyup(function(i){switch(i.which){case 32:var n=Date.now()-e;150>n&&t.timeLine().togglePlay(),e=0}}),$(document).keydown(function(e){switch(e.which){default:console.log("e.which",e.which);break;case 49:if(e.shiftKey){n=!n,t.setLayout();var i=ace.edit("ace");i.setTheme("ace/theme/twilight"),i.session.setMode("ace/mode/javascript"),i.resize()}break;case 79:(e.metaKey||e.ctrlKey)&&(CABLES.UI.SELECTPROJECT.show(),e.preventDefault());break;case 83:(e.metaKey||e.ctrlKey)&&(e.shiftKey?CABLES.api.post("project",{name:prompt("projectname","")},function(e){CABLES.UI.SELECTPROJECT.doReload=!0,t.patch().saveCurrentProject(function(){document.location.href="#/project/"+e._id},e._id,e.name)}):(t.patch().saveCurrentProject(),CABLES.UI.SELECTPROJECT.doReload=!0,e.preventDefault()));break;case 78:(e.metaKey||e.ctrlKey)&&t.createProject();break;case 27:if(e.metaKey||e.ctrlKey)return void CABLES.UI.SELECTPROJECT.show();$(".tooltip").hide(),0===t.rendererWidth?t.cycleRendererSize():$("#library").is(":visible")?$("#library").hide():$("#sidebar").is(":visible")?$("#sidebar").animate({width:"toggle"},200):$(".easingselect").is(":visible")?$(".easingselect").hide():$("#modalcontent").is(":visible")?CABLES.UI.MODAL.hide():CABLES.UI.OPSELECT.showOpSelect({x:0,y:0})}}),$("#timeline, #patch").keydown(function(i){switch(i.which){case 32:0===e&&(e=Date.now());break;case 74:t.timeLine().jumpKey(-1);break;case 75:t.timeLine().jumpKey(1)}})},this.importJson3D=function(e){CABLES.api.get("json3dimport/"+e,function(e){console.log("data",e)})},this.loadUser=function(){CABLES.api.get("user/me",function(e){e.user&&($("#loggedout").hide(),$("#loggedin").show(),$("#username").html(e.user.username))},function(e){$("#loggedout").show(),$("#loggedin").hide()})},this.init=function(){r=new CABLES.UI.Patch(this),r.show(o),e(),t.loadUser()}},document.addEventListener("DOMContentLoaded",function(e){$(document).bind("contextmenu",function(e){e.preventDefault&&e.preventDefault()}),gui=new CABLES.UI.GUI,gui.init(),gui.bind()}),CABLES.UI=CABLES.UI||{},CABLES.UI.uiConfig={portSize:10,portHeight:7,portPadding:2,colorBackground:"#333",colorLink:"#fff",colorLinkHover:"#fff",colorLinkInvalid:"#888",colorOpBg:"#ddd",colorOpBgSelected:"#ff9",colorPort:"#6c9fde",colorRubberBand:"#6c9fde",colorPortHover:"#f00",colorPatchStroke:"#6c9fde",colorSelected:"#fff",colorKey:"#6c9fde",colorKeyOther:"#ea6638",colorCursor:"#ea6638",watchValuesInterval:100,rendererSizes:[{w:640,h:360},{w:1024,h:768},{w:1280,h:720},{w:0,h:0}],getPortColor:function(e){if(!e)return"#ff0000";var t=e.getType();return t==OP_PORT_TYPE_VALUE?"#ea6638":t==OP_PORT_TYPE_FUNCTION?"#6c9fde":t==OP_PORT_TYPE_OBJECT?"#26a92a":t==OP_PORT_TYPE_ARRAY?"#a02bbd":t==OP_PORT_TYPE_DYNAMIC?"#666":"#c6c6c6"},linkingLine:{"stroke-width":1}},$("html").on("dragover",function(e){e.preventDefault(),e.stopPropagation(),$(this).addClass("dragging"),CABLES.UI.MODAL.show("drop files to upload!"),jQuery.event.props.push("dataTransfer")}),$("html").on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),$(this).removeClass("dragging")}),$("html").on("drop",function(e){e.preventDefault(),e.stopPropagation(),CABLES.UI.MODAL.showLoading("uploading");var t=e.dataTransfer.files,i="/api/project/"+gui.patch().getCurrentProject()._id+"/file",n=new FormData;$.each(t,function(e,t){n.append(e,t)});var o=new XMLHttpRequest;o.open("POST",i),o.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100|0;CABLES.UI.MODAL.showLoading("uploading "+t+"%")}},o.onload=function(e){if(gui.patch().updateProjectFiles(),200===o.status)CABLES.UI.MODAL.hide();else{var t="unknown",i=JSON.parse(e.target.response);t=i.msg,CABLES.UI.MODAL.show("upload error ("+o.status+") :"+t)}},o.send(n)});
//# sourceMappingURL=cablesui.min.js.map